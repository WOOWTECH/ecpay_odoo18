---
name: Payment Module - Callback & Status Tests
status: open
created: 2025-12-30T11:11:52Z
updated: 2025-12-30T11:11:52Z
github: [Will be updated when synced to GitHub]
depends_on: [006]
parallel: false
conflicts_with: []
---

# Task: Payment Module - Callback & Status Tests

## Description
Test ECPay payment callback handling, CheckMacValue verification, and transaction status updates for different payment scenarios.

## Acceptance Criteria
- [ ] Payment callback endpoint accessible
- [ ] CheckMacValue validation works
- [ ] Successful payment updates transaction to 'done'
- [ ] ATM/CVS pending callbacks handled correctly
- [ ] Failed payment updates transaction to 'error'
- [ ] Order status updated after payment
- [ ] Screenshots captured for status changes

## Technical Details

### Callback Endpoints
- `/payment/ecpay/return` - Return URL (user redirect)
- `/payment/ecpay/notify` - Server-to-server notification
- `/payment/ecpay/info_notify` - Payment info notification (ATM/CVS)

### Test Case 1: Successful Credit Card Payment
1. Complete a test credit card payment on ECPay sandbox
2. ECPay sends callback to `/payment/ecpay/notify`
3. Verify:
   - `RtnCode = 1` (success)
   - CheckMacValue validation passes
   - Transaction state → 'done'
   - Sale order confirmed

### Test Case 2: ATM Pending → Paid
1. Generate ATM virtual account
2. Transaction should be 'pending' with `RtnCode = 2`
3. Simulate payment (in sandbox, may need manual intervention)
4. Verify callback updates transaction to 'done'

### Test Case 3: CVS Code Generated
1. Generate CVS payment code
2. Transaction should be 'pending' with `RtnCode = 10100073`
3. Verify PaymentInfoURL callback received
4. Verify transaction stays 'pending' until paid

### Test Case 4: Failed Payment
1. Attempt payment that fails (e.g., cancelled)
2. Verify callback with failure code
3. Transaction state → 'error'
4. Error message stored

### Test Case 5: CheckMacValue Tampering
1. Send fake callback with invalid CheckMacValue
2. Verify callback rejected
3. Transaction NOT updated

### Callback Data Fields
```python
{
    'RtnCode': '1',           # 1=success, 2=ATM pending, 10100073=CVS pending
    'RtnMsg': 'Success',
    'MerchantID': '...',
    'MerchantTradeNo': '...',
    'TradeNo': '...',         # ECPay trade number
    'TradeAmt': '100',
    'PaymentDate': '...',
    'PaymentType': 'Credit_CreditCard',
    'CustomField1': '...',    # Our reference
    'CheckMacValue': '...'    # Verification hash
}
```

### RtnCode Reference
| Code | Meaning |
|------|---------|
| 1 | Payment successful |
| 2 | ATM account created |
| 10100073 | CVS/Barcode code created |
| Others | Error/Failure |

## Dependencies
- [ ] Task 006: Payment flows tested

## Effort Estimate
- Size: M
- Hours: 2
- Parallel: false (depends on Task 006)

## Definition of Done
- [ ] Callback endpoints accessible
- [ ] CheckMacValue validation working
- [ ] Success callback tested
- [ ] Pending callbacks tested (ATM/CVS)
- [ ] Failed callback tested
- [ ] Tampering protection verified
- [ ] Screenshots captured
- [ ] Test results documented
