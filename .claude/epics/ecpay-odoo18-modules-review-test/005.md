---
name: Invoice Module - Void & Allowance Tests
status: open
created: 2025-12-30T11:11:52Z
updated: 2025-12-30T11:11:52Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: false
conflicts_with: []
---

# Task: Invoice Module - Void & Allowance Tests

## Description
Test electronic invoice void (作廢) and allowance (折讓) functionality for partial refunds and invoice cancellations.

## Acceptance Criteria
- [ ] Invoice void wizard opens correctly
- [ ] Invoice void API call successful
- [ ] Invoice status updates to 'invalid' after void
- [ ] Allowance creation from credit note works
- [ ] Allowance number received from ECPay
- [ ] Remaining allowance amount updated
- [ ] Screenshots captured for each test

## Technical Details

### Test Case 1: Invoice Void (作廢)
1. Create and post a B2C invoice with e-invoice
2. Open the invoice
3. Click "作廢應收憑單電子發票" button
4. Confirm void in wizard
5. Verify:
   - ECPay API called successfully
   - `IIS_Invalid_Status = '1'`
   - `uniform_state = 'invalid'`

**Note:** Void can only be done within the same invoice period (bi-monthly)

### Test Case 2: Invoice Allowance (折讓)
1. Create and post an invoice with e-invoice (e.g., NT$1000)
2. Create a credit note (折讓單) for partial amount (e.g., NT$200)
3. Link credit note to original invoice (`IA_Invoice_No`)
4. Post the credit note
5. Run allowance function (automatic or manual)
6. Verify:
   - `IA_Allow_No` received from ECPay
   - `IIS_Remain_Allowance_Amt` updated (1000-200=800)
   - `uniform_state = 'Discounted'`

### Test Case 3: Multiple Allowances
1. Create invoice for NT$1000
2. Create first allowance for NT$200
3. Verify remaining = NT$800
4. Create second allowance for NT$300
5. Verify remaining = NT$500

### Test Case 4: Void Allowance (作廢折讓)
1. Create an allowance
2. Open the "作廢折讓發票" wizard
3. Confirm void
4. Verify allowance is invalidated

### ECPay API Endpoints Used
- `B2CInvoice/Invalid` - Void invoice
- `B2CInvoice/Allowance` - Create allowance
- `B2CInvoice/AllowanceInvalid` - Void allowance

### Business Rules
- Cannot void invoice that has allowances
- Cannot create allowance on voided invoice
- Allowance amount cannot exceed remaining amount

## Dependencies
- [ ] Task 003: Basic invoice creation working

## Effort Estimate
- Size: M
- Hours: 2
- Parallel: false (depends on Task 003)

## Definition of Done
- [ ] Invoice void tested and working
- [ ] Allowance creation tested and working
- [ ] Multiple allowances tested
- [ ] Void allowance tested (if available)
- [ ] Business rules validated
- [ ] Screenshots captured
- [ ] Test results documented
