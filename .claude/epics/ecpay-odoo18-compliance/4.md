---
name: Add Checkout Input Fields for Carrier and Lovecode
status: open
created: 2026-01-07T01:34:46Z
updated: 2026-01-07T01:45:08Z
github: https://github.com/WOOWTECH/ecpay_odoo18/issues/4
depends_on: [3]
parallel: false
conflicts_with: [3]
---

# Task: Add Checkout Input Fields for Carrier and Lovecode

## Description

Enhance the website checkout flow to include input fields for carrier numbers and lovecodes. Currently, users can select carrier type or donation option, but cannot enter the required carrier number (for mobile/natural person barcode) or lovecode (for donations).

**Module:** ecpay_invoice_website
**Related Bug:** BUG-014 (partial - frontend context issues)

## Acceptance Criteria

- [ ] Carrier number input appears when carrier type 2 (Natural Person Barcode) is selected
- [ ] Carrier number input appears when carrier type 3 (Mobile Barcode) is selected
- [ ] Lovecode input appears when donation option is selected
- [ ] Input fields have proper validation (format, length)
- [ ] Data is saved to the sale order and invoice
- [ ] Input fields are hidden when not applicable
- [ ] Mobile-responsive design

## Technical Details

### Files to Modify
- `ecpay_invoice_website/static/src/js/invoice.js`
- `ecpay_invoice_website/views/website_sale.xml`
- `ecpay_invoice_website/controllers/main.py`

### Fix Approach (per AD-3 in Epic)

**Extend existing JavaScript widget (`ECPayInvoiceHandler`):**
```javascript
// Add input field visibility logic
_updateCarrierInput() {
    const carrierType = this.$('select[name="eCarrierType"]').val();
    const showInput = ['2', '3'].includes(carrierType);
    this.$('.carrier_num_input').toggleClass('d-none', !showInput);
}

_updateLovecodeInput() {
    const isDonation = this.$('input[name="is_donation"]').is(':checked');
    this.$('.lovecode_input').toggleClass('d-none', !isDonation);
}
```

**Add QWeb template fields:**
```xml
<!-- Carrier Number Input (conditional) -->
<div class="carrier_num_input d-none">
    <label for="carrier_num">Carrier Number</label>
    <input type="text" name="carrier_num" class="form-control"
           placeholder="Enter carrier number"/>
</div>

<!-- Lovecode Input (conditional) -->
<div class="lovecode_input d-none">
    <label for="lovecode">Donation Code</label>
    <input type="text" name="lovecode" class="form-control"
           placeholder="Enter lovecode"/>
</div>
```

**Update controller to handle new fields:**
```python
@http.route('/shop/ecpay/save_invoice_type', type='json', auth='public')
def save_invoice_type(self, invoice_type, carrier_type=None, carrier_num=None,
                      is_donation=False, lovecode=None, **kwargs):
    # Validate and save carrier_num and lovecode
    pass
```

### Carrier Number Validation Rules
- Type 2 (Natural Person Barcode): 16 characters, starts with 2 capital letters
- Type 3 (Mobile Barcode): 8 characters, starts with `/`

### Lovecode Validation Rules
- 3-7 digit number
- Must be valid registered donation code

## Dependencies

- [ ] Task 002 (Readonly fields must be fixed for data to save)

## Bug Resolution Process (MANDATORY)

### Step 1: Deep Research
- [ ] Review existing invoice.js implementation
- [ ] Understand current data flow from checkout to invoice
- [ ] Check ECPay API requirements for carrier/lovecode
- [ ] Document existing QWeb template structure

### Step 2: Create Fix Plan
- [ ] Design input field HTML structure
- [ ] Plan JavaScript event handlers
- [ ] Plan controller parameter handling
- [ ] Define validation logic

### Step 3: Review Fix Plan
- [ ] Validate UX matches Taiwan e-invoice standards
- [ ] Check mobile responsiveness
- [ ] Confirm data flow to backend

### Step 4: Implement Fix
- [ ] Add input fields to QWeb template
- [ ] Extend JavaScript handlers
- [ ] Update controller to process new fields
- [ ] Add validation logic
- [ ] Commit with proper message

### Step 5: Deploy Test (Playwright MCP - Headed)
- [ ] Navigate to https://matt-test-254-odoo.woowtech.io/shop
- [ ] Add product to cart
- [ ] Proceed to checkout
- [ ] Select carrier type 2, verify carrier input appears
- [ ] Select carrier type 3, verify carrier input appears
- [ ] Select donation, verify lovecode input appears
- [ ] Complete checkout with carrier number
- [ ] Verify data saved to sale order/invoice
- [ ] Capture screenshots

### Step 6: Verify or Rollback
- [ ] If PASS: Mark task complete
- [ ] If FAIL: `git revert HEAD` and return to Step 1

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (depends on Task 002)

## Definition of Done

- [ ] Input fields appear conditionally based on selection
- [ ] Validation prevents invalid data submission
- [ ] Data saves to database correctly
- [ ] Checkout flow completes successfully
- [ ] Mobile-responsive design verified
- [ ] Tested on live instance
