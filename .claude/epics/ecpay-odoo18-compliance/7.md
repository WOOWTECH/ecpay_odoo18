---
name: Unit Tests for New Functionality
status: closed
created: 2026-01-07T01:34:46Z
updated: 2026-01-07T12:36:37Z
github: https://github.com/WOOWTECH/ecpay_odoo18/issues/7
depends_on: [3, 4, 5]
parallel: true
conflicts_with: []
---

# Task: Unit Tests for New Functionality

## Description

Create unit tests for the new and modified functionality introduced in Tasks 2-5. Focus on testing the carrier number and lovecode input handling, validation logic, and data persistence.

**Module:** ecpay_invoice_tw, ecpay_invoice_website
**Priority:** High

## Acceptance Criteria

- [x] Unit tests for carrier number input validation
- [x] Unit tests for lovecode input validation
- [x] Unit tests for field writability (no readonly issues)
- [x] Unit tests for ECPay API data preparation
- [x] All tests pass syntax check
- [x] Test coverage for critical paths

## Implementation Summary

### Files Created

```
ecpay_invoice_tw/tests/
├── __init__.py
├── test_account_move.py  (11KB, 4 test classes)
└── test_sale_order.py    (10KB, 3 test classes)
```

### Test Classes Created

**test_account_move.py:**
1. `TestAccountMoveFields` - Field writability tests (BUG-001, BUG-002, BUG-010, BUG-011, BUG-013)
2. `TestAccountMoveOnchange` - Onchange behavior tests
3. `TestAccountMoveValidation` - Validation logic tests
4. `TestAccountMoveCarrierNumDisplay` - Related field vs input field tests

**test_sale_order.py:**
1. `TestSaleOrderFields` - Field writability tests for sale.order
2. `TestSaleOrderPrepareInvoice` - `_prepare_invoice()` data flow tests (Issue #4)
3. `TestSaleOrderToInvoiceFlow` - Complete SO to invoice integration tests

### Tests Cover

- Field writability for `input_carrier_num`, `is_donation`, `is_print`, `lovecode`, `ecpay_CustomerIdentifier`
- Carrier type selection (1=ECPay, 2=Natural Person, 3=Mobile)
- Onchange behaviors (clearing fields when options change)
- Validation conflicts (print + donation, print + carrier, carrier requires number)
- Data flow from sale.order to account.move (BUG-004 verification)

### Deployment

- Tests deployed to production container via `docker cp`
- Syntax verified with `python3 -m py_compile`
- Tests structure follows Odoo 18 standards

### Note on Test Execution

Tests cannot be run directly in the Home Assistant Odoo add-on container because:
- Database runs as external service (not accessible via local socket)
- Container is configured for production, not test execution

Tests can be run in a development environment with:
```bash
odoo --test-enable --stop-after-init -d test_db -i ecpay_invoice_tw
```

## Commit

```
414fbed Issue #7: Add unit tests for ECPay invoice functionality
```

## Definition of Done

- [x] All test files created
- [x] Tests pass syntax check
- [x] Tests cover critical functionality (7 test classes, ~30 test methods)
- [x] Tests documented in this file
- [x] Code committed and pushed
