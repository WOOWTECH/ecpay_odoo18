---
name: Unit Tests for New Functionality
status: open
created: 2026-01-07T01:34:46Z
updated: 2026-01-07T01:45:08Z
github: https://github.com/WOOWTECH/ecpay_odoo18/issues/7
depends_on: [3, 4, 5]
parallel: true
conflicts_with: []
---

# Task: Unit Tests for New Functionality

## Description

Create unit tests for the new and modified functionality introduced in Tasks 2-5. Focus on testing the carrier number and lovecode input handling, validation logic, and data persistence.

**Module:** ecpay_invoice_tw, ecpay_invoice_website
**Priority:** High

## Acceptance Criteria

- [ ] Unit tests for carrier number input validation
- [ ] Unit tests for lovecode input validation
- [ ] Unit tests for field writability (no readonly issues)
- [ ] Unit tests for ECPay API data preparation
- [ ] All tests pass with `--test-enable` flag
- [ ] Test coverage for critical paths

## Technical Details

### Test Framework

Odoo 18 uses Python's unittest with custom test classes:
- `TransactionCase`: Each test method runs in its own transaction (rolled back)
- `SingleTransactionCase`: All test methods share one transaction
- `HttpCase`: For testing HTTP controllers

### Test File Structure

```
ecpay_invoice_tw/
└── tests/
    ├── __init__.py
    ├── test_account_move.py
    ├── test_carrier_validation.py
    └── test_ecpay_api.py

ecpay_invoice_website/
└── tests/
    ├── __init__.py
    └── test_checkout_controller.py
```

### Test Cases to Implement

**1. Carrier Number Validation Tests**
```python
# ecpay_invoice_tw/tests/test_carrier_validation.py
from odoo.tests.common import TransactionCase

class TestCarrierValidation(TransactionCase):

    def test_mobile_barcode_valid(self):
        """Mobile barcode should start with / and be 8 chars"""
        move = self.env['account.move'].create({
            'move_type': 'out_invoice',
            'carrierType': '3',
            'input_carrier_num': '/ABC+123',
        })
        self.assertTrue(move._validate_carrier_num())

    def test_mobile_barcode_invalid_prefix(self):
        """Mobile barcode without / should fail"""
        move = self.env['account.move'].create({
            'move_type': 'out_invoice',
            'carrierType': '3',
            'input_carrier_num': 'ABC+1234',
        })
        self.assertFalse(move._validate_carrier_num())

    def test_natural_person_valid(self):
        """Natural person barcode should be 16 chars, start with 2 letters"""
        pass
```

**2. Lovecode Validation Tests**
```python
class TestLovecodeValidation(TransactionCase):

    def test_lovecode_valid_3_digits(self):
        """3-digit lovecode should be valid"""
        pass

    def test_lovecode_valid_7_digits(self):
        """7-digit lovecode should be valid"""
        pass

    def test_lovecode_invalid_2_digits(self):
        """2-digit lovecode should fail"""
        pass
```

**3. Field Writability Tests**
```python
class TestFieldWritability(TransactionCase):

    def test_carrier_num_writable(self):
        """Carrier number field should accept values"""
        move = self.env['account.move'].create({
            'move_type': 'out_invoice',
        })
        move.write({'input_carrier_num': '/ABC+123'})
        self.assertEqual(move.input_carrier_num, '/ABC+123')

    def test_lovecode_writable(self):
        """Lovecode field should accept values"""
        pass

    def test_is_donation_writable(self):
        """is_donation should be toggleable"""
        pass
```

**4. ECPay API Data Tests**
```python
class TestECPayAPIData(TransactionCase):

    def test_api_params_include_carrier(self):
        """API params should include carrier number when set"""
        pass

    def test_api_params_include_lovecode(self):
        """API params should include lovecode for donations"""
        pass
```

**5. Controller Tests (HttpCase)**
```python
# ecpay_invoice_website/tests/test_checkout_controller.py
from odoo.tests.common import HttpCase

class TestCheckoutController(HttpCase):

    def test_save_invoice_type_with_carrier(self):
        """POST to save_invoice_type should accept carrier_num"""
        response = self.url_open('/shop/ecpay/save_invoice_type', data={
            'invoice_type': 'ecpay',
            'carrier_type': '3',
            'carrier_num': '/ABC+123',
        })
        self.assertEqual(response.status_code, 200)
```

### Running Tests

```bash
# Run all ECPay tests
odoo-bin -i ecpay_invoice_tw --test-enable -d test_db --stop-after-init

# Run specific test file
odoo-bin -i ecpay_invoice_tw --test-enable --test-tags=/ecpay_invoice_tw -d test_db

# Run with verbose output
odoo-bin -i ecpay_invoice_tw --test-enable -d test_db --log-level=test
```

## Dependencies

- [ ] Task 002 (Field changes must be implemented)
- [ ] Task 003 (Checkout changes must be implemented)
- [ ] Task 004 (Python fixes must be applied)

## Implementation Steps

### Step 1: Create Test Structure
- [ ] Create tests/ directories if not exist
- [ ] Create __init__.py files
- [ ] Create test file skeletons

### Step 2: Write Validation Tests
- [ ] Carrier number validation tests
- [ ] Lovecode validation tests
- [ ] Edge case tests

### Step 3: Write Integration Tests
- [ ] Field writability tests
- [ ] API data preparation tests
- [ ] Controller tests

### Step 4: Run and Fix
- [ ] Run all tests
- [ ] Fix any failing tests
- [ ] Ensure 100% pass rate

### Step 5: Commit
- [ ] Commit test files
- [ ] Document test coverage

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (can run after dependencies complete)

## Definition of Done

- [ ] All test files created
- [ ] All tests pass
- [ ] Tests cover critical functionality
- [ ] Tests documented
- [ ] Code committed
