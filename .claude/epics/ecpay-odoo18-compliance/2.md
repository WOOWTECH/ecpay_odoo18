---
name: Fix BUG-007 Settings Page KeyError
status: open
created: 2026-01-07T01:34:46Z
updated: 2026-01-07T01:45:08Z
github: https://github.com/WOOWTECH/ecpay_odoo18/issues/2
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Fix BUG-007 Settings Page KeyError

## Description

Fix the critical Settings page crash caused by `KeyError: 'group_mrp_routings'`. This error occurs when accessing Invoicing > Configuration > Settings after installing ECPay modules. The error is caused by the ECPay module inheriting from account settings view which references an MRP field that doesn't exist when MRP module is not installed.

**Bug ID:** BUG-007
**Severity:** Critical
**Module:** ecpay_invoice_tw
**Blocking:** All Settings-related testing

## Error Details

```
Traceback (most recent call last):
  File "res_config.py", line 230, in _get_classified_fields
    field = self._fields[name]
KeyError: 'group_mrp_routings'
```

## Acceptance Criteria

- [ ] Settings page (Invoicing > Configuration > Settings) loads without error
- [ ] ECPay settings section displays correctly
- [ ] All ECPay configuration options are accessible
- [ ] No KeyError or AttributeError in server logs
- [ ] Works both when MRP is installed and not installed

## Technical Details

### Root Cause Analysis
The ECPay module's `res.config.settings` inheritance includes or references fields from the MRP module (`group_mrp_routings`). When MRP is not installed, this field doesn't exist, causing the KeyError.

### Files to Investigate
- `ecpay_invoice_tw/models/res_config_settings.py`
- `ecpay_invoice_tw/views/res_config_setting_view.xml`

### Fix Approach (per AD-2 in Epic)
1. Investigate inheritance chain to find MRP field reference
2. Either remove the reference or add proper conditional handling
3. Options:
   - Use `hasattr()` or try/except in Python
   - Use `invisible` conditions with `groups` in XML views
   - Remove inherited views that reference MRP fields

### Odoo 18 Patterns to Follow
- Conditional field access: `if hasattr(self, 'field_name')`
- View conditional: `<field name="x" invisible="not field_exists"/>`
- Proper module dependency declaration in `__manifest__.py`

## Dependencies

- [ ] None - this is a blocking task that must be done first

## Bug Resolution Process (MANDATORY)

Follow the 6-step process defined in epic.md:

### Step 1: Deep Research
- [ ] Read Odoo 18 architecture reference at `/mnt/c/Users/Matt/Desktop/CLAUDE專案/ODOO相關/Odoo_18_Environment_Architecture`
- [ ] Trace KeyError to exact source
- [ ] Identify all MRP references in ECPay code
- [ ] Document findings

### Step 2: Create Fix Plan
- [ ] Document root cause
- [ ] Specify exact code changes
- [ ] List all files to modify
- [ ] Define rollback strategy

### Step 3: Review Fix Plan
- [ ] Validate against Odoo 18 patterns
- [ ] Check for conflicts
- [ ] Confirm minimal changes

### Step 4: Implement Fix
- [ ] Apply code changes
- [ ] Commit with BUG-007 reference
- [ ] Push to repository

### Step 5: Deploy Test (Playwright MCP - Headed)
- [ ] Navigate to https://matt-test-254-odoo.woowtech.io/
- [ ] Login: admin / admin
- [ ] Go to Invoicing > Configuration > Settings
- [ ] Verify page loads without error
- [ ] Check ECPay settings section
- [ ] Capture screenshots

### Step 6: Verify or Rollback
- [ ] If PASS: Mark task complete
- [ ] If FAIL: `git revert HEAD` and return to Step 1

## Effort Estimate

- Size: S
- Hours: 2-4
- Parallel: false (blocking issue)

## Definition of Done

- [ ] Settings page loads without KeyError
- [ ] ECPay settings accessible and functional
- [ ] Server logs show no related errors
- [ ] Tested on live instance with Playwright
- [ ] Code committed with proper message
